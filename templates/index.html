<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ROS Task Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .report-card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .entity-badge { margin-right: 5px; }
    </style>
</head>
<body class="container py-5">
    <h1 class="mb-4">ü§ñ ROS Code Checker & Sim Tool</h1>

    <div class="card p-4">
        <h3>1. Upload ROS Package (.zip)</h3>
        <input type="file" id="zipFile" class="form-control mb-3">
        <button onclick="uploadAndCheck()" class="btn btn-primary">Validate Code</button>
    </div>

    <div id="reportArea" class="report-card" style="display:none;">
        <h3>Validation Report</h3>
        <p><strong>ROS Version:</strong> <span id="rosVer"></span></p>
        <div id="entityBadges"></div>
        <hr>
        <h5>Syntax/Structure Status:</h5>
        <pre id="errorLogs" class="text-danger"></pre>
        
        <button id="simBtn" onclick="triggerSim()" class="btn btn-success mt-3" style="display:none;">
            üöÄ Run Simulation
        </button>
    </div>

   
    <div id="simResults" class="mt-4" style="display:none;">
    <h3>Simulation Results</h3>
    <div id="statusBadge" class="alert mb-3"></div> 
    
    <div class="row">
       <div class="col-md-6">
        <h5>Simulation Preview</h5>
        <img id="simFrame" src="" alt="Waiting for simulation frame..." class="img-fluid border">
    </div>
    <div class="col-md-6">
        <h5>CLI Execution Logs</h5>
        <textarea id="cliLogs" class="form-control bg-dark text-white mb-3" rows="7" readonly></textarea>
        
        <h5>Joint Motion Logs</h5>
        <textarea id="jointLogs" class="form-control bg-dark text-white" rows="7" readonly></textarea>
    </div>
    <div id="reportArea" class="report-card" style="display:none;">
        <h3>Validation Report</h3>
        <p><strong>ROS Version:</strong> <span id="rosVer"></span></p>
        <div id="entityBadges" class="mb-3"></div> <hr>
        <h5>Safety & Structure:</h5>
        <ul id="safetyWarnings" class="text-warning"></ul>
        <hr>
        <h5>Syntax/Structure Status:</h5>
        <pre id="errorLogs" class="text-danger"></pre>
        
        <button id="simBtn" onclick="triggerSim()" class="btn btn-success mt-3" style="display:none;">
            üöÄ Run Simulation
        </button>
    </div>
<script>
    async function uploadAndCheck() {
        const fileInput = document.getElementById('zipFile');
        if (!fileInput.files[0]) return alert("Please select a file");

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const res = await fetch('/upload', { method: 'POST', body: formData });
        const data = await res.json();

        document.getElementById('reportArea').style.display = 'block';
        document.getElementById('rosVer').innerText = data.ros_version;
        
        // Display ROS Entities
        const ent = data.ros_entities;
        document.getElementById('entityBadges').innerHTML = `
            <span class="badge bg-info">Pubs: ${ent.publishers}</span>
            <span class="badge bg-info">Subs: ${ent.subscribers}</span>
            <span class="badge bg-secondary">Services: ${ent.services}</span>
            <span class="badge bg-dark">Initialized: ${ent.initialized}</span>
        `;

        // Display Safety Warnings
        const safetyList = document.getElementById('safetyWarnings');
        safetyList.innerHTML = data.safety_warnings.map(w => `<li>${w}</li>`).join('') || "<li>No safety issues detected.</li>";

        // Display Syntax Errors
        document.getElementById('errorLogs').innerText = data.syntax_errors.concat(data.structure_errors).join('\n') || "No errors found!";
        
        document.getElementById('simBtn').style.display = data.passed ? 'block' : 'none';
    }
    async function triggerSim() {
    	const simBtn = document.getElementById('simBtn');
    	simBtn.disabled = true;
    	simBtn.innerText = "‚è≥ Simulating...";
    	const resultsArea = document.getElementById('simResults');

    	const res = await fetch('/run_sim', { method: 'POST' });
    	const data = await res.json();
    
    	simBtn.disabled = false;
    	simBtn.innerText = "üöÄ Run Simulation";
    	
    	resultsArea.style.display = 'block';

    	document.getElementById('simResults').style.display = 'block';
    
    	/*const badge = document.getElementById('statusBadge');
    	badge.innerText = data.status;
        badge.className = data.success ? "alert alert-success" : "alert alert-danger"; */
        const badge = document.getElementById('statusBadge');
        badge.innerText = data.status + (data.success ? " - SUCCESS" : " - FAILURE");
        badge.className = data.success ? "alert alert-success" : "alert alert-danger";
        
        const timestamp = new Date().getTime();
        //document.getElementById('simFrame').src = "/static/screenshots/final_frame.png?t=" + timestamp;
        /* const logFrame = document.querySelector('iframe');
        logFrame.src = `/static/joint_motions.log?t=${timestamp}`; */
        //logFrame.src = "/static/joint_motions.log?t=" + new Date().getTime();

       document.getElementById('cliLogs').value = data.cli_output || "CLI logs not available.";
       
       document.getElementById('jointLogs').value = data.joint_output || "Joint logs not available.";
       
       const simImg = document.getElementById('simFrame');
       simImg.src = "/static/screenshots/final_frame.png?t=" + timestamp;
       simImg.alt = "Final Frame Preview";

    simBtn.disabled = false;
    simBtn.innerText = "üöÄ Run Simulation";
       //document.getElementById('simFrame').src = "/static/screenshots/final_frame.png?t=" + new Date().getTime();
       }
</script>
</body>
</html>
